<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\identity-firebase\src\Aguacongas.Identity.Firestore\IdentityBuilderExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aguacongas.Firebase.TokenManager;
using Aguacongas.Identity.Firestore;
using Google.Apis.Auth.OAuth2;
using Google.Cloud.Firestore;
using Google.Cloud.Firestore.V1Beta1;
using Grpc.Auth;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.DependencyInjection.Extensions;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using System;
using System.Reflection;

namespace Microsoft.Extensions.DependencyInjection
{
    /// &lt;summary&gt;
    /// Contains extension methods to &lt;see cref=&quot;IdentityBuilder&quot;/&gt; for adding entity framework stores.
    /// &lt;/summary&gt;
    public static class IdentityBuilderExtensions
    {
        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;configure&quot;&gt;Action to configure AuthTokenOptions&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirestoreStores(this IdentityBuilder builder, Action&lt;OAuthServiceAccountKey&gt; configure)
        {
            var services = builder.Services;
            services.Configure(configure)
                .AddTransient(provider =&gt;
                {
                    var authOptions = provider.GetRequiredService&lt;IOptions&lt;OAuthServiceAccountKey&gt;&gt;();
                    var json = JsonConvert.SerializeObject(authOptions.Value);
                    var credentials = GoogleCredential.FromJson(json)
                        .CreateScoped(&quot;https://www.googleapis.com/auth/datastore&quot;);
                    var channel = new Grpc.Core.Channel(
                        FirestoreClient.DefaultEndpoint.ToString(),
                        credentials.ToChannelCredentials());
                    var client = FirestoreClient.Create(channel);
                    return FirestoreDb.Create(authOptions.Value.project_id, client: client);
                });
            AddStores(services, builder.UserType, builder.RoleType);
            return builder;
        }

        private static void AddStores(IServiceCollection services, Type userType, Type roleType)
        {
            var identityUserType = FindGenericBaseType(userType, typeof(IdentityUser&lt;string&gt;));
            if (identityUserType == null)
            {
                throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a user that derives from IdentityUser&lt;string&gt;.&quot;);
            }

            var userOnlyStoreType = typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType);

            if (roleType != null)
            {
                var identityRoleType = FindGenericBaseType(roleType, typeof(IdentityRole&lt;string&gt;));
                if (identityRoleType == null)
                {
                    throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a role that derives from IdentityRole&lt;string&gt;.&quot;);
                }

                var userStoreType = typeof(UserStore&lt;,&gt;).MakeGenericType(userType, roleType);
                var roleStoreType = typeof(RoleStore&lt;&gt;).MakeGenericType(roleType);

                services.TryAddScoped(typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userStoreType);
                services.TryAddScoped(typeof(IRoleStore&lt;&gt;).MakeGenericType(roleType), roleStoreType);
            }
            else
            {   // No Roles
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
            }
        }

        private static TypeInfo FindGenericBaseType(Type currentType, Type genericBaseType)
        {
            var type = currentType;
            while (type != null)
            {
                var typeInfo = type.GetTypeInfo();
                var genericType = type.IsGenericType ? type: null;
                if (genericType != null &amp;&amp; genericType == genericBaseType)
                {
                    return typeInfo;
                }
                type = type.BaseType;
            }
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,1],[29,13,29,45,1],[30,13,32,17,1],[32,17,32,18,1],[32,18,33,21,1],[33,21,33,103,1],[33,103,34,21,1],[34,21,34,79,1],[34,79,35,21,1],[35,21,36,84,1],[36,84,37,21,1],[37,21,39,61,1],[39,61,40,21,1],[40,21,40,66,1],[40,66,41,21,1],[41,21,41,93,1],[41,93,42,17,1],[42,17,42,18,1],[42,18,42,20,1],[30,13,42,20,1],[43,13,43,69,1],[44,13,44,28,1],[45,9,45,10,1],[48,9,48,10,1],[49,13,49,96,1],[50,13,50,42,1],[51,13,51,14,0],[52,17,52,152,0],[55,13,55,87,1],[57,13,57,34,1],[58,13,58,14,1],[59,17,59,100,1],[60,17,60,46,1],[61,17,61,18,0],[62,21,62,156,0],[65,17,65,94,1],[66,17,66,83,1],[68,17,68,109,1],[69,17,69,102,1],[70,17,70,102,1],[71,13,71,14,1],[73,13,73,14,0],[74,17,74,106,0],[75,13,75,14,0],[76,9,76,10,1],[79,9,79,10,1],[80,13,80,36,1],[81,13,81,33,1],[82,13,82,14,1],[83,17,83,51,1],[84,17,84,67,1],[85,17,85,75,1],[86,17,86,18,1],[87,21,87,37,1],[89,17,89,38,1],[90,13,90,14,1],[91,13,91,25,0],[92,9,92,10,1]]);
    </script>
  </body>
</html>