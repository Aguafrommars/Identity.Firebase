<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\identity-firebase\src\Aguacongas.Identity.Firebase\IdentityBuilderExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

using System;
using System.Net.Http;
using System.Reflection;
using Aguacongas.Firebase;
using Aguacongas.Firebase.Http;
using Aguacongas.Firebase.TokenManager;
using Aguacongas.Identity.Firebase;
using Google.Apis.Auth.OAuth2;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.DependencyInjection.Extensions;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;

namespace Microsoft.Extensions.DependencyInjection
{
    /// &lt;summary&gt;
    /// Contains extension methods to &lt;see cref=&quot;IdentityBuilder&quot;/&gt; for adding entity framework stores.
    /// &lt;/summary&gt;
    public static class IdentityBuilderExtensions
    {
        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;Firebase url&lt;/param&gt;
        /// &lt;param name=&quot;getTokenAccess&quot;&gt;&lt;see cref=&quot;ITokenAccess&quot;/&gt; factory function&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder, string url, Func&lt;IServiceProvider, ITokenAccess&gt; getTokenAccess)
        {
            AddStores(builder.Services, builder.UserType, builder.RoleType);
            builder.Services.AddFirebaseClient(url, getTokenAccess);

            return builder;
        }

        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;Firebase url&lt;/param&gt;
        /// &lt;param name=&quot;getTokenManager&quot;&gt;&lt;see cref=&quot;IFirebaseTokenManager&quot;/&gt; factory function&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder, string url, Func&lt;IServiceProvider, IFirebaseTokenManager&gt; getTokenManager)
        {
            AddStores(builder.Services, builder.UserType, builder.RoleType);
            builder.Services.AddFirebaseClient(url, getTokenManager);

            return builder;
        }

        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;Firebase url&lt;/param&gt;
        /// &lt;param name=&quot;configure&quot;&gt;Action to configure AuthTokenOptions&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder, string url, Action&lt;AuthTokenOptions&gt; configure)
        {
            builder.Services.Configure(configure);

            return builder
                .AddFirebaseStores(url, provider =&gt;
                {
                    var options = provider.GetRequiredService&lt;IOptions&lt;AuthTokenOptions&gt;&gt;();
                    var json = JsonConvert.SerializeObject(options?.Value ?? throw new ArgumentNullException(nameof(options)));
                    return GoogleCredential.FromJson(json)
                        .CreateScoped(&quot;https://www.googleapis.com/auth/userinfo.email&quot;, &quot;https://www.googleapis.com/auth/firebase.database&quot;)
                        .UnderlyingCredential;
                });
        }

        private static void AddStores(IServiceCollection services, Type userType, Type roleType)
        {
            var identityUserType = FindGenericBaseType(userType, typeof(IdentityUser&lt;string&gt;));
            if (identityUserType == null)
            {
                throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a user that derives from IdentityUser&lt;string&gt;.&quot;);
            }

            var userOnlyStoreType = typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType);

            if (roleType != null)
            {
                var identityRoleType = FindGenericBaseType(roleType, typeof(IdentityRole&lt;string&gt;));
                if (identityRoleType == null)
                {
                    throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a role that derives from IdentityRole&lt;string&gt;.&quot;);
                }

                var userStoreType = typeof(UserStore&lt;,&gt;).MakeGenericType(userType, roleType);
                var roleStoreType = typeof(RoleStore&lt;&gt;).MakeGenericType(roleType);

                services.TryAddScoped(typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userStoreType);
                services.TryAddScoped(typeof(IRoleStore&lt;&gt;).MakeGenericType(roleType), roleStoreType);
            }
            else
            {   // No Roles
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
            }
        }

        private static TypeInfo FindGenericBaseType(Type currentType, Type genericBaseType)
        {
            var type = currentType;
            while (type != null)
            {
                var typeInfo = type.GetTypeInfo();
                var genericType = type.IsGenericType ? type: null;
                if (genericType != null &amp;&amp; genericType == genericBaseType)
                {
                    return typeInfo;
                }
                type = type.BaseType;
            }
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[32,9,32,10,1],[33,13,33,77,1],[34,13,34,69,1],[36,13,36,28,1],[37,9,37,10,1],[47,9,47,10,1],[48,13,48,77,1],[49,13,49,70,1],[51,13,51,28,1],[52,9,52,10,1],[62,9,62,10,1],[63,13,63,51,1],[65,13,67,17,1],[67,17,67,18,1],[67,18,68,21,1],[68,21,68,93,1],[68,93,69,21,1],[69,21,69,128,1],[69,128,70,21,1],[70,21,72,47,1],[72,47,73,17,1],[73,17,73,18,1],[73,18,73,20,1],[65,13,73,20,1],[74,9,74,10,1],[77,9,77,10,1],[78,13,78,96,1],[79,13,79,42,1],[80,13,80,14,0],[81,17,81,152,0],[84,13,84,87,1],[86,13,86,34,1],[87,13,87,14,1],[88,17,88,100,1],[89,17,89,46,1],[90,17,90,18,0],[91,21,91,156,0],[94,17,94,94,1],[95,17,95,83,1],[97,17,97,109,1],[98,17,98,102,1],[99,17,99,102,1],[100,13,100,14,1],[102,13,102,14,0],[103,17,103,106,0],[104,13,104,14,0],[105,9,105,10,1],[108,9,108,10,1],[109,13,109,36,1],[110,13,110,33,1],[111,13,111,14,1],[112,17,112,51,1],[113,17,113,67,1],[114,17,114,75,1],[115,17,115,18,1],[116,21,116,37,1],[118,17,118,38,1],[119,13,119,14,1],[120,13,120,25,0],[121,9,121,10,1]]);
    </script>
  </body>
</html>