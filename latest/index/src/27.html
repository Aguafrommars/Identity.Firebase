<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\identity-firebase\src\Aguacongas.Identity.Firebase\IdentityBuilderExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aguacongas.Firebase;
using Aguacongas.Firebase.TokenManager;
using Aguacongas.Identity.Firebase;
using Google.Apis.Auth.OAuth2;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.DependencyInjection.Extensions;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using System;
using System.Reflection;

namespace Microsoft.Extensions.DependencyInjection
{
    /// &lt;summary&gt;
    /// Contains extension methods to &lt;see cref=&quot;IdentityBuilder&quot;/&gt; for adding entity framework stores.
    /// &lt;/summary&gt;
    public static class IdentityBuilderExtensions
    {
        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;Firebase url&lt;/param&gt;
        /// &lt;param name=&quot;getTokenAccess&quot;&gt;&lt;see cref=&quot;ITokenAccess&quot;/&gt; factory function&lt;/param&gt;
        /// &lt;param name=&quot;httpClientName&quot;&gt;The name of HttpClient&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder, string url, Func&lt;IServiceProvider, ITokenAccess&gt; getTokenAccess, string httpClientName = &quot;Aguacongas.Identity.Firebase&quot;)
        {
            AddStores(builder.Services, builder.UserType, builder.RoleType);
            builder.Services.AddFirebaseClient(url, getTokenAccess, httpClientName);

            return builder;
        }

        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;Firebase url&lt;/param&gt;
        /// &lt;param name=&quot;getTokenManager&quot;&gt;&lt;see cref=&quot;IFirebaseTokenManager&quot;/&gt; factory function&lt;/param&gt;
        /// &lt;param name=&quot;httpClientName&quot;&gt;The name of HttpClient&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder, string url, Func&lt;IServiceProvider, IFirebaseTokenManager&gt; getTokenManager, string httpClientName = &quot;Aguacongas.Identity.Firebase&quot;)
        {
            AddStores(builder.Services, builder.UserType, builder.RoleType);
            builder.Services.AddFirebaseClient(url, getTokenManager, httpClientName);

            return builder;
        }

        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;url&quot;&gt;Firebase url&lt;/param&gt;
        /// &lt;param name=&quot;configure&quot;&gt;Action to configure AuthTokenOptions&lt;/param&gt;
        /// &lt;param name=&quot;httpClientName&quot;&gt;The name of HttpClient&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder, string url, Action&lt;OAuthServiceAccountKey&gt; configure, string httpClientName = &quot;Aguacongas.Identity.Firebase&quot;)
        {
            builder.Services.Configure(configure);

            return builder
                .AddFirebaseStores(url, provider =&gt;
                {
                    var options = provider.GetRequiredService&lt;IOptions&lt;OAuthServiceAccountKey&gt;&gt;();
                    var json = JsonConvert.SerializeObject(options?.Value ?? throw new ArgumentNullException(nameof(options)));
                    return GoogleCredential.FromJson(json)
                        .CreateScoped(&quot;https://www.googleapis.com/auth/userinfo.email&quot;, &quot;https://www.googleapis.com/auth/firebase.database&quot;)
                        .UnderlyingCredential;
                }, httpClientName);
        }

        private static void AddStores(IServiceCollection services, Type userType, Type roleType)
        {
            var identityUserType = FindGenericBaseType(userType, typeof(IdentityUser&lt;string&gt;));
            if (identityUserType == null)
            {
                throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a user that derives from IdentityUser&lt;string&gt;.&quot;);
            }

            var userOnlyStoreType = typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType);

            if (roleType != null)
            {
                var identityRoleType = FindGenericBaseType(roleType, typeof(IdentityRole&lt;string&gt;));
                if (identityRoleType == null)
                {
                    throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a role that derives from IdentityRole&lt;string&gt;.&quot;);
                }

                var userStoreType = typeof(UserStore&lt;,&gt;).MakeGenericType(userType, roleType);
                var roleStoreType = typeof(RoleStore&lt;&gt;).MakeGenericType(roleType);

                services.TryAddScoped(typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userStoreType);
                services.TryAddScoped(typeof(IRoleStore&lt;&gt;).MakeGenericType(roleType), roleStoreType);
            }
            else
            {   // No Roles
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
            }
        }

        private static TypeInfo FindGenericBaseType(Type currentType, Type genericBaseType)
        {
            var type = currentType;
            while (type != null)
            {
                var typeInfo = type.GetTypeInfo();
                var genericType = type.IsGenericType ? type: null;
                if (genericType != null &amp;&amp; genericType == genericBaseType)
                {
                    return typeInfo;
                }
                type = type.BaseType;
            }
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,1],[29,13,29,77,1],[30,13,30,85,1],[32,13,32,28,1],[33,9,33,10,1],[44,9,44,10,1],[45,13,45,77,1],[46,13,46,86,1],[48,13,48,28,1],[49,9,49,10,1],[60,9,60,10,1],[61,13,61,51,1],[63,13,65,17,1],[65,17,65,18,1],[65,18,66,21,1],[66,21,66,99,1],[66,99,67,21,1],[67,21,67,128,1],[67,128,68,21,1],[68,21,70,47,1],[70,47,71,17,1],[71,17,71,18,1],[71,18,71,36,1],[63,13,71,36,1],[72,9,72,10,1],[75,9,75,10,1],[76,13,76,96,1],[77,13,77,42,1],[78,13,78,14,0],[79,17,79,152,0],[82,13,82,87,1],[84,13,84,34,1],[85,13,85,14,1],[86,17,86,100,1],[87,17,87,46,1],[88,17,88,18,0],[89,21,89,156,0],[92,17,92,94,1],[93,17,93,83,1],[95,17,95,109,1],[96,17,96,102,1],[97,17,97,102,1],[98,13,98,14,1],[100,13,100,14,0],[101,17,101,106,0],[102,13,102,14,0],[103,9,103,10,1],[106,9,106,10,1],[107,13,107,36,1],[108,13,108,33,1],[109,13,109,14,1],[110,17,110,51,1],[111,17,111,67,1],[112,17,112,75,1],[113,17,113,18,1],[114,21,114,37,1],[116,17,116,38,1],[117,13,117,14,1],[118,13,118,25,0],[119,9,119,10,1]]);
    </script>
  </body>
</html>