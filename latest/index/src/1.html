<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\identity-firebase\src\Aguacongas.Identity.Firestore\IdentityBuilderExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Aguacongas.Firebase.TokenManager;
using Aguacongas.Identity.Firestore;
using Google.Apis.Auth.OAuth2;
using Google.Cloud.Firestore;
using Google.Cloud.Firestore.V1Beta1;
using Grpc.Auth;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.DependencyInjection.Extensions;
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using System;
using System.Reflection;

namespace Microsoft.Extensions.DependencyInjection
{
    /// &lt;summary&gt;
    /// Contains extension methods to &lt;see cref=&quot;IdentityBuilder&quot;/&gt; for adding entity framework stores.
    /// &lt;/summary&gt;
    public static class IdentityBuilderExtensions
    {
        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;param name=&quot;configure&quot;&gt;Action to configure AuthTokenOptions&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirestoreStores(this IdentityBuilder builder, Action&lt;OAuthServiceAccountKey&gt; configure)
        {
            var services = builder.Services;
            services.Configure(configure)
                .AddTransient(provider =&gt;
                {
                    var authOptions = provider.GetRequiredService&lt;IOptions&lt;OAuthServiceAccountKey&gt;&gt;();
                    var json = JsonConvert.SerializeObject(authOptions.Value);
                    var credentials = GoogleCredential.FromJson(json)
                        .CreateScoped(&quot;https://www.googleapis.com/auth/datastore&quot;);
                    var channel = new Grpc.Core.Channel(
                        FirestoreClient.DefaultEndpoint.ToString(),
                        credentials.ToChannelCredentials());
                    var client = FirestoreClient.Create(channel);
                    var firestoreOptions = provider.GetRequiredService&lt;IOptions&lt;FirestoreOptions&gt;&gt;();
                    return FirestoreDb.Create(firestoreOptions.Value.Project, client: client);
                });
            AddStores(services, builder.UserType, builder.RoleType);
            return builder;
        }

        private static void AddStores(IServiceCollection services, Type userType, Type roleType)
        {
            var identityUserType = FindGenericBaseType(userType, typeof(IdentityUser&lt;string&gt;));
            if (identityUserType == null)
            {
                throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a user that derives from IdentityUser&lt;string&gt;.&quot;);
            }

            var userOnlyStoreType = typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType);

            if (roleType != null)
            {
                var identityRoleType = FindGenericBaseType(roleType, typeof(IdentityRole&lt;string&gt;));
                if (identityRoleType == null)
                {
                    throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a role that derives from IdentityRole&lt;string&gt;.&quot;);
                }

                var userStoreType = typeof(UserStore&lt;,&gt;).MakeGenericType(userType, roleType);
                var roleStoreType = typeof(RoleStore&lt;&gt;).MakeGenericType(roleType);

                services.TryAddScoped(typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userStoreType);
                services.TryAddScoped(typeof(IRoleStore&lt;&gt;).MakeGenericType(roleType), roleStoreType);
            }
            else
            {   // No Roles
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userOnlyStoreType);
            }
        }

        private static TypeInfo FindGenericBaseType(Type currentType, Type genericBaseType)
        {
            var type = currentType;
            while (type != null)
            {
                var typeInfo = type.GetTypeInfo();
                var genericType = type.IsGenericType ? type: null;
                if (genericType != null &amp;&amp; genericType == genericBaseType)
                {
                    return typeInfo;
                }
                type = type.BaseType;
            }
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[29,13,29,45,0],[30,13,32,17,0],[32,17,32,18,0],[32,18,33,21,0],[33,21,33,103,0],[33,103,34,21,0],[34,21,34,79,0],[34,79,35,21,0],[35,21,36,84,0],[36,84,37,21,0],[37,21,39,61,0],[39,61,40,21,0],[40,21,40,66,0],[40,66,41,21,0],[41,21,41,102,0],[41,102,42,21,0],[42,21,42,95,0],[42,95,43,17,0],[43,17,43,18,0],[43,18,43,20,0],[30,13,43,20,0],[44,13,44,69,0],[45,13,45,28,0],[46,9,46,10,0],[49,9,49,10,0],[50,13,50,96,0],[51,13,51,42,0],[52,13,52,14,0],[53,17,53,152,0],[56,13,56,87,0],[58,13,58,34,0],[59,13,59,14,0],[60,17,60,100,0],[61,17,61,46,0],[62,17,62,18,0],[63,21,63,156,0],[66,17,66,94,0],[67,17,67,83,0],[69,17,69,109,0],[70,17,70,102,0],[71,17,71,102,0],[72,13,72,14,0],[74,13,74,14,0],[75,17,75,106,0],[76,13,76,14,0],[77,9,77,10,0],[80,9,80,10,0],[81,13,81,36,0],[82,13,82,33,0],[83,13,83,14,0],[84,17,84,51,0],[85,17,85,67,0],[86,17,86,75,0],[87,17,87,18,0],[88,21,88,37,0],[90,17,90,38,0],[91,13,91,14,0],[92,13,92,25,0],[93,9,93,10,0]]);
    </script>
  </body>
</html>