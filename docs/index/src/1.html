<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\Projects\Perso\Identity.Firebase\src\Aguacongas.Firebase\FirebaseClient.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using Microsoft.Extensions.Options;
using Newtonsoft.Json;
using System;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;

namespace Aguacongas.Firebase
{
    public class FirebaseClient : IFirebaseClient
    {
        private readonly HttpClient _httpClient;
        private readonly string _url;
        private readonly IFirebaseTokenManager _tokenManager;
        private readonly JsonSerializerSettings _jsonSerializerSettings;

        public FirebaseClient(HttpClient httpClient, IOptions&lt;FirebaseOptions&gt; options)
        {            
            _httpClient = httpClient;
            var value = options.Value;            
            _tokenManager = value.FirebaseTokenManager;
            _url = value.DatabaseUrl;
            _jsonSerializerSettings = value.JsonSerializerSettings;

            if (!_url.EndsWith(&quot;/&quot;))
            {
                _url = _url + &quot;/&quot;;
            }
        }

        public async Task&lt;string&gt; PostAsync&lt;T&gt;(string url, T data, CancellationToken cancellationToken = default(CancellationToken))
        {
            if(data == null)
            {
                throw new ArgumentNullException(nameof(data));
            }
            var response = await _httpClient.PostAsync(await GetFirebaseUrl(url, cancellationToken), _httpClient.CreateJsonContent(data, _jsonSerializerSettings), cancellationToken);
            var postResponse = await response.DeserializeResponseAsync&lt;PostResponse&gt;(_jsonSerializerSettings);
            return postResponse.Name;
        }

        public async Task&lt;T&gt; PutAsync&lt;T&gt;(string url, T data, CancellationToken cancellationToken = default(CancellationToken))
        {
            if (data == null)
            {
                throw new ArgumentNullException(nameof(data));
            }
            var response = await _httpClient.PutAsync(await GetFirebaseUrl(url, cancellationToken), _httpClient.CreateJsonContent(data), cancellationToken);
            return await GetResponse&lt;T&gt;(response);
        }

        public async Task&lt;T&gt; PatchAsync&lt;T&gt;(string url, T data, CancellationToken cancellationToken = default(CancellationToken))
        {
            if (data == null)
            {
                throw new ArgumentNullException(nameof(data));
            }

            var message = new HttpRequestMessage(new HttpMethod(&quot;PATCH&quot;), await GetFirebaseUrl(url, cancellationToken))
            {
                Content = _httpClient.CreateJsonContent(data, _jsonSerializerSettings)
            };

            var response = await _httpClient.SendAsync(message, cancellationToken);
            return await GetResponse&lt;T&gt;(response);
        }

        public async Task DeleteAsync(string url, CancellationToken cancellationToken = default(CancellationToken))
        {
            using (var response =
                await _httpClient.DeleteAsync(await GetFirebaseUrl(url, cancellationToken), cancellationToken))
            {
                response.EnsureSuccessStatusCode();
            }                
        }

        public async Task&lt;T&gt; GetAsync&lt;T&gt;(string url, CancellationToken cancellationToken = default(CancellationToken))
        {
            var response = await _httpClient.GetAsync(await GetFirebaseUrl(url, cancellationToken), cancellationToken);
            return await GetResponse&lt;T&gt;(response);
        }

        private async Task&lt;T&gt; GetResponse&lt;T&gt;(HttpResponseMessage response)
        {
            using (response)
            {
                return await response.DeserializeResponseAsync&lt;T&gt;(_jsonSerializerSettings);
            }
        }

        private async Task&lt;string&gt; GetFirebaseUrl(string url, CancellationToken cancellationToken)
        {
            if (string.IsNullOrEmpty(url))
            {
                throw new ArgumentNullException(nameof(url));
            }

            var sanetizedUrl = url;
            if (!url.EndsWith(&quot;.json&quot;))
            {
                sanetizedUrl = url + &quot;.json&quot;;
            }

            while (sanetizedUrl.StartsWith(&quot;/&quot;))
            {
                sanetizedUrl = sanetizedUrl.Substring(1);
            }

            return $&quot;{_url}{sanetizedUrl}?auth={await _tokenManager.GetTokenAsync(cancellationToken)}&quot;;
        }

        class PostResponse
        {
            public string Name { get; set; }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[17,9,17,88,1],[18,9,18,10,1],[19,13,19,38,1],[20,13,20,39,1],[21,13,21,56,1],[22,13,22,38,1],[23,13,23,68,1],[25,13,25,37,1],[26,13,26,14,1],[27,17,27,35,1],[28,13,28,14,1],[29,9,29,10,1],[32,9,32,10,1],[33,13,33,29,1],[34,13,34,14,1],[35,17,35,63,1],[37,13,37,183,1],[38,13,38,111,1],[39,13,39,38,1],[40,9,40,10,1],[43,9,43,10,1],[44,13,44,30,1],[45,13,45,14,1],[46,17,46,63,1],[48,13,48,157,1],[49,13,49,51,1],[50,9,50,10,1],[53,9,53,10,1],[54,13,54,30,1],[55,13,55,14,1],[56,17,56,63,1],[59,13,62,15,1],[64,13,64,84,1],[65,13,65,51,1],[66,9,66,10,1],[69,9,69,10,1],[70,20,71,111,1],[72,13,72,14,1],[73,17,73,52,1],[74,13,74,14,1],[75,9,75,10,1],[78,9,78,10,1],[79,13,79,120,1],[80,13,80,51,1],[81,9,81,10,1],[84,9,84,10,1],[85,13,85,29,1],[86,13,86,14,1],[87,17,87,92,1],[89,9,89,10,1],[92,9,92,10,1],[93,13,93,43,1],[94,13,94,14,1],[95,17,95,62,1],[98,13,98,36,1],[99,13,99,40,1],[100,13,100,14,1],[101,17,101,46,1],[102,13,102,14,1],[104,13,104,49,1],[105,13,105,14,1],[106,17,106,58,1],[107,13,107,14,1],[109,13,109,104,1],[110,9,110,10,1],[114,34,114,38,1],[114,39,114,43,1]]);
    </script>
  </body>
</html>