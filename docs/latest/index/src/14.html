<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\projects\identity-firebase\src\Aguacongas.Identity.Firebase\IdentityBuilderExtensions.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

using System;
using System.Net.Http;
using System.Reflection;
using Aguacongas.Firebase;
using Aguacongas.Firebase.TokenManager;
using Aguacongas.Identity.Firebase;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.DependencyInjection.Extensions;

namespace Microsoft.Extensions.DependencyInjection
{
    /// &lt;summary&gt;
    /// Contains extension methods to &lt;see cref=&quot;IdentityBuilder&quot;/&gt; for adding entity framework stores.
    /// &lt;/summary&gt;
    public static class IdentityBuilderExtensions
    {
        /// &lt;summary&gt;
        /// Adds an Firebase implementation of identity information stores.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;builder&quot;&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/param&gt;
        /// &lt;returns&gt;The &lt;see cref=&quot;IdentityBuilder&quot;/&gt; instance this method extends.&lt;/returns&gt;
        public static IdentityBuilder AddFirebaseStores(this IdentityBuilder builder)
        {
            AddStores(builder.Services, builder.UserType, builder.RoleType);
            return builder;
        }

        private static void AddStores(IServiceCollection services, Type userType, Type roleType)
        {
            var identityUserType = FindGenericBaseType(userType, typeof(IdentityUser&lt;string&gt;));
            if (identityUserType == null)
            {
                throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a user that derives from IdentityUser&lt;string&gt;.&quot;);
            }

            if (roleType != null)
            {
                var identityRoleType = FindGenericBaseType(roleType, typeof(IdentityRole&lt;string&gt;));
                if (identityRoleType == null)
                {
                    throw new InvalidOperationException(&quot;AddEntityFrameworkStores can only be called with a role that derives from IdentityRole&lt;string&gt;.&quot;);
                }

                Type userStoreType = null;
                Type roleStoreType = null;
                // If its a custom DbContext, we can only add the default POCOs
                userStoreType = typeof(UserStore&lt;,&gt;).MakeGenericType(userType, roleType);
                roleStoreType = typeof(RoleStore&lt;&gt;).MakeGenericType(roleType);

                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userStoreType);
                services.TryAddScoped(typeof(IRoleStore&lt;&gt;).MakeGenericType(userType), roleStoreType);
            }
            else
            {   // No Roles
                Type userStoreType = null;
                    // If its a custom DbContext, we can only add the default POCOs
                userStoreType = typeof(UserOnlyStore&lt;&gt;).MakeGenericType(userType);
                services.TryAddScoped(typeof(IUserStore&lt;&gt;).MakeGenericType(userType), userStoreType);
            }

            services.AddScoped&lt;HttpClient&gt;()
                .AddScoped&lt;IFirebaseClient, FirebaseClient&gt;()
                .AddScoped&lt;IFirebaseTokenManager, EmailPasswordTokenManager&gt;();
        }

        private static TypeInfo FindGenericBaseType(Type currentType, Type genericBaseType)
        {
            var type = currentType;
            while (type != null)
            {
                var typeInfo = type.GetTypeInfo();
                var genericType = type.IsGenericType ? type: null;
                if (genericType != null &amp;&amp; genericType == genericBaseType)
                {
                    return typeInfo;
                }
                type = type.BaseType;
            }
            return null;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[26,9,26,10,1],[27,13,27,77,1],[28,13,28,28,1],[29,9,29,10,1],[32,9,32,10,1],[33,13,33,96,1],[34,13,34,42,1],[35,13,35,14,0],[36,17,36,152,0],[39,13,39,34,1],[40,13,40,14,1],[41,17,41,100,1],[42,17,42,46,1],[43,17,43,18,0],[44,21,44,156,0],[47,17,47,43,1],[48,17,48,43,1],[50,17,50,90,1],[51,17,51,79,1],[53,17,53,102,1],[54,17,54,102,1],[55,13,55,14,1],[57,13,57,14,0],[58,17,58,43,0],[60,17,60,83,0],[61,17,61,102,0],[62,13,62,14,0],[64,13,66,80,1],[67,9,67,10,1],[70,9,70,10,1],[71,13,71,36,1],[72,13,72,33,1],[73,13,73,14,1],[74,17,74,51,1],[75,17,75,67,1],[76,17,76,75,1],[77,17,77,18,1],[78,21,78,37,1],[80,17,80,38,1],[81,13,81,14,1],[82,13,82,25,0],[83,9,83,10,1]]);
    </script>
  </body>
</html>